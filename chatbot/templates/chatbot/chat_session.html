{% extends 'base.html' %}
{% load static %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'chatbot/css/chatbot.css' %}">
{% endblock %}

{% block title %}{{ session.title }} - {{ block.super }}{% endblock %}

{% block page_title %}{{ session.title }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'chatbot:chat_list' %}">Sohbetler</a></li>
<li class="breadcrumb-item active">{{ session.title }}</li>
{% endblock %}

{% block page_actions %}
<div class="btn-group">
    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#renameModal">
        <i class="fas fa-edit me-1"></i> Yeniden Adlandır
    </button>
    <a href="{% url 'chatbot:new_chat_session' %}" class="btn btn-sm btn-primary">
        <i class="fas fa-plus me-1"></i> Yeni Sohbet
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-3">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="card-title mb-0">Sohbetleriniz</h5>
                <a href="{% url 'chatbot:new_chat_session' %}" class="btn btn-sm btn-primary">
                    <i class="fas fa-plus"></i>
                </a>
            </div>
            <div class="list-group list-group-flush">
                {% for session_item in request.user.chatsession_set.all|dictsortreversed:"updated_at"|slice:":10" %}
                <a href="{% url 'chatbot:chat_session' session_id=session_item.id %}" 
                   class="list-group-item list-group-item-action {% if session_item.id == session.id %}active{% endif %}">
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1 text-truncate">{{ session_item.title }}</h6>
                        <small>{{ session_item.updated_at|date:"d.m.Y" }}</small>
                    </div>
                    <small class="text-truncate d-block">
                        {% with last_message=session_item.messages.last %}
                            {% if last_message %}
                                {% if last_message.sender == 'user' %}Siz: {% endif %}
                                {{ last_message.content|truncatechars:50 }}
                            {% else %}
                                Yeni sohbet
                            {% endif %}
                        {% endwith %}
                    </small>
                </a>
                {% empty %}
                <div class="list-group-item text-center text-muted">
                    <small>Henüz sohbet başlatılmadı</small>
                </div>
                {% endfor %}
                {% if request.user.chatsession_set.count > 10 %}
                <a href="{% url 'chatbot:chat_list' %}" class="list-group-item list-group-item-action text-center">
                    <small><i class="fas fa-ellipsis-h me-1"></i> Tümünü Gör</small>
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    
    <div class="col-md-9">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <div class="d-flex align-items-center">
                    <h5 class="card-title mb-0 me-3">{{ session.title }}</h5>
                    <div class="dropdown">
                        <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" id="modelDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="fas fa-robot me-1"></i> {{ session.get_ai_model_display }}
                        </button>
                        <ul class="dropdown-menu" aria-labelledby="modelDropdown">
                            <li><a class="dropdown-item" href="#" data-model="gemma3:4b">Gemma 3 (4B) - Hızlı ve Verimli</a></li>
                            <li><a class="dropdown-item" href="#" data-model="deepseek-r1:8b">DeepSeek R1 (8B) - Gelişmiş Akıl Yürütme</a></li>
                        </ul>
                    </div>
                </div>
                <button type="button" class="btn btn-sm btn-outline-danger" data-bs-toggle="modal" data-bs-target="#deleteModal">
                    <i class="fas fa-trash me-1"></i> Sohbeti Sil
                </button>
            </div>
            <div class="card-body chat-container" style="height: 60vh; overflow-y: auto;">
                <div id="chat-messages">
                    {% if not messages %}
                    <div class="text-center text-muted my-5">
                        <i class="fas fa-robot fa-3x mb-3"></i>
                        <h5>AI Yardımcıya Hoş Geldiniz</h5>
                        <p>Size nasıl yardımcı olabilirim?</p>
                    </div>
                    {% else %}
                        {% for message in messages %}
                            <div class="message-container {% if message.sender == 'user' %}text-end{% endif %} mb-3">
                                <div class="message-bubble p-3 rounded d-inline-block {% if message.sender == 'user' %}bg-primary text-white{% else %}bg-light{% endif %}" 
                                     style="max-width: 80%;">
                                    {{ message.content|linebreaksbr }}
                                </div>
                                <div class="message-time small text-muted mt-1">
                                    {{ message.timestamp|date:"d.m.Y H:i" }}
                                </div>
                            </div>
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
            <div class="card-footer">
                <form id="chat-form" data-session-id="{{ session.id }}">
                    {% csrf_token %}
                    <div class="input-group">
                        <input type="text" id="chat-input" class="form-control" 
                               placeholder="Mesajınızı yazın..." required autocomplete="off">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Rename Modal -->
<div class="modal fade" id="renameModal" tabindex="-1" aria-labelledby="renameModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="renameModalLabel">Sohbet Başlığını Değiştir</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" action="{% url 'chatbot:rename_session' session_id=session.id %}">
                {% csrf_token %}
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="sessionTitle" class="form-label">Yeni Başlık</label>
                        <input type="text" class="form-control" id="sessionTitle" name="title" 
                               value="{{ session.title }}" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                    <button type="submit" class="btn btn-primary">Kaydet</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteModalLabel">Sohbeti Sil</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>Bu sohbeti silmek istediğinizden emin misiniz? Bu işlem geri alınamaz.</p>
                <p class="fw-bold text-danger">{{ session.title }}</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">İptal</button>
                <a href="{% url 'chatbot:delete_session' session_id=session.id %}" class="btn btn-danger">Sil</a>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');
        const sessionId = chatForm.getAttribute('data-session-id');
        
        console.log("Chat session initialized with session ID:", sessionId);
        
        // Debug element values
        if (!sessionId) {
            console.error("WARNING: Session ID is missing or empty!");
            appendErrorMessage("Oturum ID bulunamadı. Lütfen sayfayı yenileyin veya sistem yöneticisine başvurun.");
        }
        
        // Scroll to bottom of chat on load
        scrollToBottom();
        
        // Send message function
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = chatInput.value.trim();
            if (!message) return;
            
            console.log("Sending message:", message.substring(0, 30) + (message.length > 30 ? "..." : ""));
            console.log("Session ID:", sessionId);
            
            if (!sessionId) {
                console.error("Cannot send message: Session ID is missing");
                appendErrorMessage("Mesaj gönderilemedi: Oturum ID bulunamadı.");
                return;
            }
            
            // Clear input
            chatInput.value = '';
            
            // Show loading state
            appendMessage(message, 'user');
            appendLoadingIndicator();
            
            // Get CSRF token
            const csrftoken = getCookie('csrftoken');
            
            // Debugging information
            console.log("CSRF Token:", csrftoken ? "Present (length " + csrftoken.length + ")" : "Missing");
            console.log("Sending with JSON payload:", JSON.stringify({
                session_id: sessionId,
                message: message.substring(0, 30) + (message.length > 30 ? "..." : "")
            }));
            
            // Method 1: JSON request
            fetch('{% url "chatbot:send_message" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    session_id: sessionId,
                    message: message
                })
            })
            .then(response => {
                console.log("JSON Response status:", response.status);
                console.log("JSON Response headers:", Object.fromEntries([...response.headers.entries()]));
                if (!response.ok) {
                    // JSON başarısız olursa form verisi olarak deneyelim
                    throw new Error('JSON request failed with status ' + response.status + ', trying form data');
                }
                return response.json();
            })
            .then(data => {
                // Remove loading indicator
                removeLoadingIndicator();
                
                if (data.error) {
                    // Show error
                    console.error("Server error:", data.error);
                    
                    // Eğer yeni bir session oluşturulduysa, sessionId güncelle
                    if (data.new_session_id) {
                        console.log("New session was created. Updating session ID:", data.new_session_id);
                        sessionId = data.new_session_id;
                        
                        chatForm.setAttribute('data-session-id', sessionId);
                        console.log("Updated form with new session ID");
                        
                        // Bilgilendirme mesajı göster
                        appendMessage(
                            "Yeni bir oturum oluşturuldu. Mesajınızı tekrar gönderebilirsiniz.", 
                            'assistant'
                        );
                        return; // Hata mesajı gösterme
                    }
                    
                    if (data.received_data) {
                        console.log("Received data:", data.received_data);
                    }
                    appendErrorMessage(data.error);
                } else {
                    // Show AI response
                    appendMessage(data.assistant_message.content, 'assistant');
                }
                
                // Scroll to bottom
                scrollToBottom();
            })
            .catch(error => {
                console.error('JSON request error:', error);
                
                // Method 2: Form Data request (fallback)
                const formData = new FormData();
                formData.append('session_id', sessionId);
                formData.append('message', message);
                
                console.log("Falling back to FormData. Form entries:", [...formData.entries()]);
                
                fetch('{% url "chatbot:send_message" %}', {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken
                    },
                    body: formData
                })
                .then(response => {
                    console.log("FormData Response status:", response.status);
                    console.log("FormData Response headers:", Object.fromEntries([...response.headers.entries()]));
                    return response.json();
                })
                .then(data => {
                    // Remove loading indicator
                    removeLoadingIndicator();
                    
                    if (data.error) {
                        // Show error
                        console.error("Server error from FormData method:", data.error);
                        
                        // Eğer yeni bir session oluşturulduysa, sessionId güncelle
                        if (data.new_session_id) {
                            console.log("New session was created. Updating session ID:", data.new_session_id);
                            sessionId = data.new_session_id;
                            
                            chatForm.setAttribute('data-session-id', sessionId);
                            console.log("Updated form with new session ID");
                            
                            // Bilgilendirme mesajı göster
                            appendMessage(
                                "Yeni bir oturum oluşturuldu. Mesajınızı tekrar gönderebilirsiniz.", 
                                'assistant'
                            );
                            return; // Hata mesajı gösterme
                        }
                        
                        if (data.received_data) {
                            console.log("Received data:", data.received_data);
                        }
                        appendErrorMessage(data.error);
                    } else {
                        // Show AI response
                        appendMessage(data.assistant_message.content, 'assistant');
                    }
                    
                    // Scroll to bottom
                    scrollToBottom();
                })
                .catch(finalError => {
                    // Remove loading indicator
                    removeLoadingIndicator();
                    console.error('Form data request error:', finalError);
                    appendErrorMessage('İletişim hatası oluştu. Lütfen tekrar deneyin. Hata: ' + finalError.message);
                    scrollToBottom();
                });
            });
        });
        
        // Helper function to append a message to the chat
        function appendMessage(content, sender) {
            // For empty chat, clear welcome message
            if (chatMessages.querySelector('.text-center.text-muted.my-5')) {
                chatMessages.innerHTML = '';
            }
            
            const messageContainer = document.createElement('div');
            messageContainer.className = `message-container ${sender === 'user' ? 'text-end' : ''} mb-3`;
            
            const time = new Date();
            const timeString = `${time.toLocaleDateString('tr-TR')} ${time.getHours().toString().padStart(2, '0')}:${time.getMinutes().toString().padStart(2, '0')}`;
            
            // Kod bloklarını işle
            const processedContent = processCodeBlocks(content);
            
            messageContainer.innerHTML = `
                <div class="message-bubble p-3 rounded d-inline-block ${sender === 'user' ? 'bg-primary text-white' : 'bg-light'}" 
                     style="max-width: 80%;">
                    ${processedContent}
                </div>
                <div class="message-time small text-muted mt-1">
                    ${timeString}
                </div>
            `;
            
            chatMessages.appendChild(messageContainer);
            
            // Kod blokları için kopyalama butonlarını etkinleştir
            if (sender === 'assistant') {
                activateCodeCopyButtons(messageContainer);
            }
            
            scrollToBottom();
        }
        
        // Kod bloklarını algılama ve işleme fonksiyonu
        function processCodeBlocks(content) {
            // Markdown kod bloklarını işle (```...```)
            let processed = content.replace(/```([\s\S]*?)```/g, function(match, codeContent) {
                const language = codeContent.split('\n')[0].trim();
                let code = codeContent;
                
                // Dil belirtilmişse ilk satırı kaldır
                if (language && !language.includes('=') && !language.includes('(') && !language.includes(')')) {
                    code = codeContent.split('\n').slice(1).join('\n');
                }
                
                return `<div class="code-block-container position-relative">
                    <div class="code-copy-btn position-absolute" style="top: 5px; right: 5px;">
                        <button class="copy-code-btn">
                            Kopyala
                        </button>
                    </div>
                    <pre class="bg-dark text-light p-2 rounded"><code>${escapeHtml(code)}</code></pre>
                </div>`;
            });
            
            // İnline kodları işle (`...`)
            processed = processed.replace(/`([^`]+)`/g, '<code class="bg-dark text-light px-1 rounded">$1</code>');
            
            // Normal satır geçişlerini <br> ile değiştir
            return processed.replace(/\n/g, '<br>');
        }
        
        // HTML özel karakterlerini escape et
        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }
        
        // Kopyalama butonlarını etkinleştir
        function activateCodeCopyButtons(container) {
            const copyButtons = container.querySelectorAll('.copy-code-btn');
            copyButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const codeBlock = this.closest('.code-block-container').querySelector('code');
                    // HTML entity'lerini decode et ve formatı koru
                    let textToCopy = codeBlock.innerHTML;
                    
                    // <br> taglarını newline'a çevir
                    textToCopy = textToCopy.replace(/<br\s*\/?>/gi, '\n');
                    
                    // HTML entity'lerini decode et
                    const textarea = document.createElement('textarea');
                    textarea.innerHTML = textToCopy;
                    textToCopy = textarea.value;
                    
                    // Kopyalama fonksiyonu
                    function copyToClipboard(text) {
                        // Modern clipboard API'yi dene
                        if (navigator.clipboard && window.isSecureContext) {
                            return navigator.clipboard.writeText(text);
                        } else {
                            // Fallback: textarea kullan
                            return new Promise((resolve, reject) => {
                                const textArea = document.createElement('textarea');
                                textArea.value = text;
                                textArea.style.position = 'fixed';
                                textArea.style.left = '-999999px';
                                textArea.style.top = '-999999px';
                                document.body.appendChild(textArea);
                                textArea.focus();
                                textArea.select();
                                
                                try {
                                    const successful = document.execCommand('copy');
                                    document.body.removeChild(textArea);
                                    if (successful) {
                                        resolve();
                                    } else {
                                        reject(new Error('Copy command failed'));
                                    }
                                } catch (err) {
                                    document.body.removeChild(textArea);
                                    reject(err);
                                }
                            });
                        }
                    }
                    
                    // Panoya kopyala
                    copyToClipboard(textToCopy).then(() => {
                        // Başarılı olduğunda butonu geçici olarak değiştir
                        const originalHTML = this.innerHTML;
                        this.innerHTML = 'Kopyalandı!';
                        this.classList.remove('btn-light');
                        this.classList.add('btn-success');
                        
                        // 2 saniye sonra butonu eski haline getir
                        setTimeout(() => {
                            this.innerHTML = originalHTML;
                            this.classList.remove('btn-success');
                            this.classList.add('btn-light');
                        }, 2000);
                    }).catch(err => {
                        console.error('Kopyalama hatası:', err);
                        alert('Kopyalama işlemi başarısız oldu. Lütfen kodu manuel olarak seçip kopyalayın.');
                    });
                });
            });
        }
        
        // Helper function to append a loading indicator
        function appendLoadingIndicator() {
            const loadingContainer = document.createElement('div');
            loadingContainer.className = 'message-container mb-3';
            loadingContainer.id = 'chat-loading-indicator';
            
            loadingContainer.innerHTML = `
                <div class="message-bubble p-3 rounded d-inline-block bg-light" style="max-width: 80%;">
                    <div class="d-flex align-items-center">
                        <div class="spinner-grow spinner-grow-sm text-primary" role="status">
                            <span class="visually-hidden">Yükleniyor...</span>
                        </div>
                        <div class="ms-2">Yazıyor...</div>
                    </div>
                </div>
            `;
            
            chatMessages.appendChild(loadingContainer);
            scrollToBottom();
        }
        
        // Helper function to remove the loading indicator
        function removeLoadingIndicator() {
            const loadingIndicator = document.getElementById('chat-loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.remove();
            }
        }
        
        // Helper function to append an error message
        function appendErrorMessage(errorText) {
            const errorContainer = document.createElement('div');
            errorContainer.className = 'message-container mb-3';
            
            errorContainer.innerHTML = `
                <div class="message-bubble p-3 rounded d-inline-block bg-danger text-white" style="max-width: 80%;">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    ${errorText}
                </div>
            `;
            
            chatMessages.appendChild(errorContainer);
            scrollToBottom();
        }
        
        // Helper function to get CSRF token
        function getCookie(name) {
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            
            // CSRF token formdaki input elementinden de alınabilir
            if (!cookieValue) {
                const tokenInput = document.querySelector('input[name="csrfmiddlewaretoken"]');
                if (tokenInput) {
                    cookieValue = tokenInput.value;
                    console.log("CSRF token found in form input");
                }
            }
            
            if (!cookieValue) {
                console.error(`${name} cookie not found!`);
            }
            return cookieValue;
        }
        
        // Helper function to scroll to bottom of chat
        function scrollToBottom() {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        // Sayfa yüklendiğinde mevcut mesajları işle
        function processPreviousMessages() {
            const existingMessages = document.querySelectorAll('.message-container .message-bubble');
            existingMessages.forEach(messageBubble => {
                // Kullanıcı mesajlarını atla (sadece asistan mesajlarındaki kodları işle)
                if (messageBubble.classList.contains('bg-primary')) return;
                
                const originalContent = messageBubble.innerHTML;
                // ```...``` kalıplarını ara ve işle
                if (originalContent.includes('```')) {
                    const processedContent = processCodeBlocks(originalContent.replace(/<br>/g, '\n'));
                    messageBubble.innerHTML = processedContent;
                    
                    // Mesaj bubble'ın bulunduğu container'ı bul
                    const messageContainer = messageBubble.closest('.message-container');
                    if (messageContainer) {
                        activateCodeCopyButtons(messageContainer);
                    }
                }
            });
        }
        
        // Sayfa yüklendiğinde mevcut mesajları işle
        processPreviousMessages();
        
        // Focus input on load
        chatInput.focus();
        
        // Model selection functionality
        const modelDropdown = document.getElementById('modelDropdown');
        const modelDropdownItems = document.querySelectorAll('#modelDropdown + .dropdown-menu .dropdown-item');
        
        modelDropdownItems.forEach(item => {
            item.addEventListener('click', function(e) {
                e.preventDefault();
                const selectedModel = this.getAttribute('data-model');
                const modelName = this.textContent;
                
                // Update dropdown button text
                modelDropdown.innerHTML = `<i class="fas fa-robot me-1"></i> ${modelName}`;
                
                // Update session model via AJAX
                updateSessionModel(selectedModel);
            });
        });
        
        function updateSessionModel(model) {
            const csrftoken = getCookie('csrftoken');
            
            fetch('{% url "chatbot:chat_session" session_id=session.id %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrftoken
                },
                body: JSON.stringify({
                    'action': 'update_model',
                    'ai_model': model
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Show success message
                    appendMessage(`AI modeli "${model}" olarak güncellendi.`, 'assistant');
                } else {
                    console.error('Model update failed:', data.error);
                }
            })
            .catch(error => {
                console.error('Model update error:', error);
            });
        }
    });
</script>
{% endblock %} 