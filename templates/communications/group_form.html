{% extends 'base.html' %}
{% load static %}

{% block title %}{{ title }}{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block extra_css %}
<link href="{% static 'vendor/select2/css/select2.min.css' %}" rel="stylesheet" type="text/css" />
<link href="{% static 'vendor/select2-bootstrap-theme/select2-bootstrap4.min.css' %}" rel="stylesheet" type="text/css" />
<style>
    .preview-image {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        overflow: hidden;
        margin-top: 10px;
    }
    .preview-image img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }
    .required-field label::after {
        content: " *";
        color: red;
    }
</style>
{% endblock %}

{% block breadcrumb %}
<div class="page-title-box">
    <div class="page-title-right">
        <ol class="breadcrumb m-0">
            <li class="breadcrumb-item"><a href="{% url 'dashboard:index' %}">Ana Sayfa</a></li>
            <li class="breadcrumb-item"><a href="{% url 'communications:chat_list' %}">Mesajlar</a></li>
            <li class="breadcrumb-item active">{{ title }}</li>
        </ol>
    </div>
    <h4 class="page-title">{{ title }}</h4>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="card">
            <div class="card-body">
                <form method="post" enctype="multipart/form-data" id="groupForm">
                    {% csrf_token %}
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="mb-3 required-field">
                                <label for="name" class="form-label">Grup Adı</label>
                                <input type="text" class="form-control" id="name" name="name" required {% if group %}value="{{ group.name }}"{% endif %}>
                            </div>
                            
                            <div class="mb-3">
                                <label for="description" class="form-label">Açıklama</label>
                                <textarea class="form-control" id="description" name="description" rows="3">{% if group %}{{ group.description }}{% endif %}</textarea>
                            </div>
                            
                            {% if not group or group.type != 'direct' %}
                            <div class="mb-3">
                                <label for="type" class="form-label">Grup Tipi</label>
                                <select class="form-select" id="type" name="type" {% if group and group.type == 'direct' %}disabled{% endif %}>
                                    <option value="group" {% if group and group.type == 'group' %}selected{% endif %}>Standart Grup</option>
                                    <option value="project" {% if group and group.type == 'project' %}selected{% endif %}>Proje Grubu</option>
                                    <option value="task" {% if group and group.type == 'task' %}selected{% endif %}>Görev Grubu</option>
                                </select>
                                {% if group and group.type == 'direct' %}
                                <input type="hidden" name="type" value="direct">
                                {% endif %}
                            </div>
                            {% endif %}
                            
                            <div class="mb-3">
                                <label for="image" class="form-label">Grup Resmi</label>
                                <input type="file" class="form-control" id="image" name="image" accept="image/*">
                                
                                {% if group and group.image %}
                                <div class="mt-2">
                                    <div class="preview-image">
                                        <img src="{{ group.image.url }}" alt="{{ group.name }}">
                                    </div>
                                </div>
                                {% else %}
                                <div class="mt-2 d-none" id="imagePreview">
                                    <div class="preview-image">
                                        <img src="" alt="Grup Resmi Önizleme">
                                    </div>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="members" class="form-label">Grup Üyeleri</label>
                                <select class="select2 form-control" id="members" name="members" multiple data-placeholder="Üye seçin...">
                                    {% for user in users %}
                                    <option value="{{ user.id }}" {% if current_members and user.id in current_members %}selected{% endif %}>
                                        {{ user.get_full_name|default:user.username }}
                                    </option>
                                    {% endfor %}
                                </select>
                                <small class="form-text text-muted">Grupta olmasını istediğiniz kişileri seçin. Kendiniz otomatik olarak ekleneceksiniz.</small>
                            </div>
                            
                            <div class="mb-3" id="projectField">
                                <label for="project" class="form-label">İlişkili Proje</label>
                                <select class="select2 form-control" id="project" name="project" data-placeholder="Proje seçin...">
                                    <option value="">Seçim yok</option>
                                    {% for project in projects %}
                                    <option value="{{ project.id }}" {% if group and group.related_project and group.related_project.id == project.id %}selected{% endif %}>
                                        {{ project.name }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            
                            <div class="mb-3" id="taskField">
                                <label for="task" class="form-label">İlişkili Görev</label>
                                <select class="select2 form-control" id="task" name="task" data-placeholder="Görev seçin...">
                                    <option value="">Seçim yok</option>
                                    {% for task in tasks %}
                                    <option value="{{ task.id }}" {% if group and group.related_task and group.related_task.id == task.id %}selected{% endif %}>
                                        {{ task.title }} ({{ task.project.name }})
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <div class="text-end mt-3">
                        <a href="{% if group %}{% url 'communications:chat_detail' group_id=group.id %}{% else %}{% url 'communications:chat_list' %}{% endif %}" class="btn btn-secondary me-2">
                            <i class="mdi mdi-arrow-left"></i> Vazgeç
                        </a>
                        <button type="submit" class="btn btn-primary">
                            <i class="mdi mdi-content-save"></i> {% if group %}Değişiklikleri Kaydet{% else %}Grup Oluştur{% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="{% static 'vendor/select2/js/select2.min.js' %}"></script>
<script>
    $(document).ready(function() {
        // Select2 başlat
        $('.select2').select2({
            theme: 'bootstrap4',
            width: '100%'
        });
        
        // Grup tipine göre proje/görev alanlarını göster/gizle
        function toggleFields() {
            var type = $('#type').val();
            
            if (type === 'project') {
                $('#projectField').show();
                $('#taskField').hide();
            } else if (type === 'task') {
                $('#projectField').show();
                $('#taskField').show();
            } else {
                $('#projectField').show();
                $('#taskField').show();
            }
        }
        
        $('#type').on('change', toggleFields);
        toggleFields();
        
        // Resim önizleme
        $('#image').on('change', function() {
            var file = this.files[0];
            if (file) {
                var reader = new FileReader();
                reader.onload = function(e) {
                    $('#imagePreview img').attr('src', e.target.result);
                    $('#imagePreview').removeClass('d-none');
                }
                reader.readAsDataURL(file);
            } else {
                $('#imagePreview').addClass('d-none');
            }
        });
        
        // Görev seçildiğinde ilgili projeyi otomatik seç
        $('#task').on('change', function() {
            if ($(this).val()) {
                var selectedOption = $(this).find('option:selected');
                var taskProject = selectedOption.text().match(/\((.*?)\)$/)[1];
                
                $('#project option').each(function() {
                    if ($(this).text() === taskProject) {
                        $('#project').val($(this).val()).trigger('change');
                    }
                });
            }
        });
    });
</script>
{% endblock %} 