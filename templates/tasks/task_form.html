{% extends 'base.html' %}

{% block title %}{{ title }} - GlichFlow{% endblock %}

{% block page_title %}{{ title }}{% endblock %}

{% block breadcrumb %}
<li class="breadcrumb-item"><a href="{% url 'projects:project_list' %}">Projeler</a></li>
{% if project %}
<li class="breadcrumb-item"><a href="{% url 'projects:project_detail' project.id %}">{{ project.name }}</a></li>
{% endif %}
<li class="breadcrumb-item active">{{ task.title|default:"Yeni Görev" }}</li>
{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8 mx-auto">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">{{ task.title|default:"Yeni Görev" }}</h5>
            </div>
            <div class="card-body">
                <form method="post" enctype="multipart/form-data">
                    {% csrf_token %}
                    
                    <div class="mb-3">
                        <label for="title" class="form-label">Görev Başlığı *</label>
                        <input type="text" class="form-control" id="title" name="title" value="{{ task.title|default:'' }}" required>
                    </div>
                    
                    <div class="mb-3">
                        <label for="description" class="form-label">Açıklama</label>
                        <textarea class="form-control" id="description" name="description" rows="4">{{ task.description|default:'' }}</textarea>
                    </div>
                    
                    {% if not project %}
                    <div class="mb-3">
                        <label for="project" class="form-label">Proje *</label>
                        <select class="form-select" id="project" name="project" required>
                            <option value="">-- Proje Seçin --</option>
                            {% for p in projects %}
                            <option value="{{ p.id }}" {% if task.project and task.project.id == p.id %}selected{% endif %}>
                                {{ p.name }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    {% else %}
                    <input type="hidden" name="project" value="{{ project.id }}">
                    {% endif %}
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="status" class="form-label">Durum *</label>
                            <select class="form-select" id="status" name="status" required>
                                {% for key, value in status_choices %}
                                <option value="{{ key }}" {% if task.status == key %}selected{% endif %}>{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="priority" class="form-label">Öncelik *</label>
                            <select class="form-select" id="priority" name="priority" required>
                                {% for key, value in priority_choices %}
                                <option value="{{ key }}" {% if task.priority == key %}selected{% endif %}>{{ value }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="assignee" class="form-label">Atanan Kişi</label>
                        <select class="form-select" id="assignee" name="assignee">
                            <option value="">-- Kişi Seçin --</option>
                            {% for user in users %}
                            <option value="{{ user.id }}" {% if task.assignee and task.assignee.id == user.id %}selected{% endif %}>
                                {{ user.get_full_name|default:user.username }}
                            </option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="start_date" class="form-label">Başlangıç Tarihi</label>
                            <input type="date" class="form-control" id="start_date" name="start_date" value="{{ task.start_date|date:'Y-m-d'|default:'' }}">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="due_date" class="form-label">Son Tarih</label>
                            <input type="date" class="form-control" id="due_date" name="due_date" value="{{ task.due_date|date:'Y-m-d'|default:'' }}">
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="estimate_hours" class="form-label">Tahmini Süre (Saat)</label>
                            <input type="number" class="form-control" id="estimate_hours" name="estimate_hours" step="0.5" value="{{ task.estimate_hours|default:'' }}">
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="actual_hours" class="form-label">Gerçekleşen Süre (Saat)</label>
                            <input type="number" class="form-control" id="actual_hours" name="actual_hours" step="0.5" value="{{ task.actual_hours|default:'' }}">
                        </div>
                    </div>
                    
                    {% if project %}
                    <div class="mb-3">
                        <label for="parent_task" class="form-label">Üst Görev</label>
                        <select class="form-select" id="parent_task" name="parent_task">
                            <option value="">-- Üst Görev Yok --</option>
                            {% for pt in project_tasks %}
                            {% if pt.id != task.id %}
                            <option value="{{ pt.id }}" {% if task.parent_task and task.parent_task.id == pt.id %}selected{% endif %}>
                                {{ pt.title }}
                            </option>
                            {% endif %}
                            {% endfor %}
                        </select>
                    </div>
                    {% endif %}

                    <!-- PRD Ekleme Seçeneği -->
                    <div class="card mt-4">
                        <div class="card-header">
                            <h6 class="mb-0">
                                <i class="fas fa-file-alt text-primary"></i> PRD (Product Requirements Document)
                            </h6>
                        </div>
                        <div class="card-body">
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="create_prd" name="create_prd">
                                <label class="form-check-label" for="create_prd">
                                    <strong>Bu görev için PRD oluştur</strong>
                                </label>
                                <div class="form-text">İsteğe bağlı: Görev için detaylı gereksinim dokümanı oluşturmak istiyorsanız işaretleyin.</div>
                            </div>
                            
                            <div id="prd_fields" style="display: none;">
                                <div class="mb-3">
                                    <label for="prd_title" class="form-label">PRD Başlığı</label>
                                    <input type="text" class="form-control" id="prd_title" name="prd_title" placeholder="Örn: Görev Adı - PRD">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="prd_product_summary" class="form-label">Ürün Özeti</label>
                                    <textarea class="form-control" id="prd_product_summary" name="prd_product_summary" rows="3" placeholder="Ürünün genel açıklaması ve amacı"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="prd_target_audience" class="form-label">Hedef Kitle</label>
                                    <textarea class="form-control" id="prd_target_audience" name="prd_target_audience" rows="3" placeholder="Ürünün hedef kullanıcıları ve kullanım senaryoları"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="prd_functional_requirements" class="form-label">Fonksiyonel Gereksinimler</label>
                                    <textarea class="form-control" id="prd_functional_requirements" name="prd_functional_requirements" rows="4" placeholder="Ürünün ne yapacağını açıklayan gereksinimler"></textarea>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="prd_document" class="form-label">PRD Dosyası (Opsiyonel)</label>
                                    <input type="file" class="form-control" id="prd_document" name="prd_document" accept=".pdf,.doc,.docx,.txt">
                                    <div class="form-text">PDF, Word veya metin dosyası yükleyebilirsiniz. Maksimum dosya boyutu: 10MB</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="d-flex justify-content-end mt-4">
                        {% if project %}
                        <a href="{% url 'projects:project_detail' project.id %}" class="btn btn-secondary me-2">İptal</a>
                        {% else %}
                        <a href="{% url 'tasks:task_list' %}" class="btn btn-secondary me-2">İptal</a>
                        {% endif %}
                        <button type="submit" class="btn btn-primary">Kaydet</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<!-- Select2 for better dropdown experience -->
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script>
    $(document).ready(function() {
        $('#assignee').select2({
            placeholder: 'Kişi seçin',
            allowClear: true
        });
        
        $('#project').select2({
            placeholder: 'Proje seçin',
            allowClear: true
        });
        
        $('#parent_task').select2({
            placeholder: 'Üst görev seçin',
            allowClear: true
        });
        
        // PRD alanlarını göster/gizle
        $('#create_prd').change(function() {
            if ($(this).is(':checked')) {
                $('#prd_fields').slideDown();
            } else {
                $('#prd_fields').slideUp();
            }
        });
        
        // Görev başlığı değiştiğinde PRD başlığını otomatik güncelle
        $('#title').on('input', function() {
            var taskTitle = $(this).val();
            if (taskTitle) {
                $('#prd_title').val(taskTitle + ' - PRD');
            }
        });
    });
</script>
{% endblock %} 